<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ê¸°í™” í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a4fd1;
        }
        .test-result {
            background: #f8f9fa;
            border-left: 4px solid #6c5ce7;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-result.success {
            border-left-color: #00b894;
        }
        .test-result.error {
            border-left-color: #d63031;
        }
        .sync-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .status-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #6c5ce7;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ ë“œë˜ê·¸ íŒì—…ê³¼ í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—… ë™ê¸°í™” í…ŒìŠ¤íŠ¸</h1>

    <div class="test-container">
        <h2>í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
        <p>ì´ í…ŒìŠ¤íŠ¸ëŠ” ë“œë˜ê·¸ íŒì—…ì—ì„œ ì €ì¥í•œ ë°ì´í„°ê°€ í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—…ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>

        <button class="test-button" onclick="testStorageSync()">ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testDragPopupSync()">ë“œë˜ê·¸ íŒì—… ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testCrossContextEvents()">í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testEventSystem()">ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testDataRefresh()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testCategoryManager()">CategoryManager í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testClipManager()">ClipManager í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testPopupLoading()">íŒì—… ë¡œë”© í…ŒìŠ¤íŠ¸</button>
        <button class="test-button" onclick="testChromeStorage()">Chrome Storage ì§ì ‘ í™•ì¸</button>
        <button class="test-button" onclick="createTestClip()">í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„±</button>
        <button class="test-button" onclick="clearTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬</button>
    </div>

    <div class="test-container">
        <h2>ë™ê¸°í™” ìƒíƒœ</h2>
        <div class="sync-status" id="syncStatus">
            <div class="status-card">
                <h3>í´ë¦½ ìˆ˜</h3>
                <div class="status-value" id="clipCount">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="status-card">
                <h3>ì¹´í…Œê³ ë¦¬ ìˆ˜</h3>
                <div class="status-value" id="categoryCount">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="status-card">
                <h3>ë§ˆì§€ë§‰ ë™ê¸°í™”</h3>
                <div class="status-value" id="lastSync">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="status-card">
                <h3>ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ</h3>
                <div class="status-value" id="eventListeners">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
        <div id="testResults"></div>
    </div>

    <script>
        let testResults = [];

        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
        function addTestResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}</strong><br>
                ${message}
            `;

            const resultsContainer = document.getElementById('testResults');
            resultsContainer.insertBefore(resultDiv, resultsContainer.firstChild);

            // ê²°ê³¼ ì €ì¥
            testResults.push({ message, type, timestamp: Date.now() });
        }

        // ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateSyncStatus() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    // í™•ì¥ í”„ë¡œê·¸ë¨ í™˜ê²½ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤í¬ë¦½íŠ¸ì— ìƒíƒœ ìš”ì²­
                    const response = await chrome.runtime.sendMessage({ action: 'getSyncStatus' });

                    if (response && response.success) {
                        const status = response.data;
                        document.getElementById('clipCount').textContent = status.clips?.length || 0;
                        document.getElementById('categoryCount').textContent = status.categories?.length || 0;
                        document.getElementById('lastSync').textContent = status.lastSync ? new Date(status.lastSync).toLocaleTimeString() : 'ì—†ìŒ';
                        document.getElementById('eventListeners').textContent = status.eventListeners || 0;
                    }
                } else {
                    // ì¼ë°˜ ì›¹ í˜ì´ì§€ í™˜ê²½ì—ì„œëŠ” localStorage í™•ì¸
                    const clips = JSON.parse(localStorage.getItem('clips') || '[]');
                    const categories = JSON.parse(localStorage.getItem('categories') || '[]');

                    document.getElementById('clipCount').textContent = clips.length;
                    document.getElementById('categoryCount').textContent = categories.length;
                    document.getElementById('lastSync').textContent = 'í…ŒìŠ¤íŠ¸ í™˜ê²½';
                    document.getElementById('eventListeners').textContent = 'ì‹œë®¬ë ˆì´ì…˜';
                }
            } catch (error) {
                addTestResult(`ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” í…ŒìŠ¤íŠ¸
        async function testStorageSync() {
            addTestResult('ğŸ”„ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                const testClip = {
                    id: 'test_clip_' + Date.now(),
                    title: 'ë™ê¸°í™” í…ŒìŠ¤íŠ¸ í´ë¦½',
                    text: 'ì´ê²ƒì€ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í´ë¦½ì…ë‹ˆë‹¤.',
                    source: 'test',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                const clips = JSON.parse(localStorage.getItem('clips') || '[]');
                clips.push(testClip);
                localStorage.setItem('clips', JSON.stringify(clips));

                addTestResult('âœ… í…ŒìŠ¤íŠ¸ í´ë¦½ ì €ì¥ ì„±ê³µ', 'success');

                // ìƒíƒœ ì—…ë°ì´íŠ¸ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 1000));
                await updateSyncStatus();

                // ë°ì´í„° í™•ì¸
                const updatedClips = JSON.parse(localStorage.getItem('clips') || '[]');
                const savedClip = updatedClips.find(c => c.id === testClip.id);

                if (savedClip) {
                    addTestResult('âœ… ë°ì´í„° ì €ì¥ ë° ì½ê¸° ë™ê¸°í™” ì„±ê³µ', 'success');
                } else {
                    addTestResult('âŒ ë°ì´í„° ë™ê¸°í™” ì‹¤íŒ¨', 'error');
                }

            } catch (error) {
                addTestResult(`âŒ ìŠ¤í† ë¦¬ì§€ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë“œë˜ê·¸ íŒì—… ë™ê¸°í™” í…ŒìŠ¤íŠ¸ (ìƒˆë¡œìš´ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸)
        async function testDragPopupSync() {
            addTestResult('ğŸ”„ ë“œë˜ê·¸ íŒì—… ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    addTestResult('ğŸ” ë“œë˜ê·¸ íŒì—… ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

                    // 1. ë“œë˜ê·¸ íŒì—…ì—ì„œ í´ë¦½ ì €ì¥ ì‹œë®¬ë ˆì´ì…˜
                    const dragPopupClip = {
                        id: 'drag_test_' + Date.now(),
                        title: 'ë“œë˜ê·¸ íŒì—…ì—ì„œ ì €ì¥',
                        text: 'ë“œë˜ê·¸ íŒì—…ì„ í†µí•´ ì €ì¥ëœ í…ŒìŠ¤íŠ¸ í´ë¦½ì…ë‹ˆë‹¤.',
                        source: 'chatgpt',
                        categoryIds: [],
                        tags: ['í…ŒìŠ¤íŠ¸', 'ë“œë˜ê·¸'],
                        createdAt: Date.now(),
                        url: 'https://chat.openai.com/test'
                    };

                    // ë°±ê·¸ë¼ìš´ë“œ ìŠ¤í¬ë¦½íŠ¸ì— ì €ì¥ ìš”ì²­ (ë“œë˜ê·¸ íŒì—… ì‹œë®¬ë ˆì´ì…˜)
                    const saveResponse = await chrome.runtime.sendMessage({
                        action: 'saveClipFromSelection',
                        data: dragPopupClip
                    });

                    addTestResult(`ğŸ“ ë“œë˜ê·¸ íŒì—… ì €ì¥ ìš”ì²­: ${saveResponse?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);

                    // 2. ì €ì¥ í™•ì¸ì„ ìœ„í•œ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // 3. í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—…ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const getClipsResponse = await chrome.runtime.sendMessage({
                        action: 'getClips'
                    });

                    addTestResult(`ğŸ“Š í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—… ë°ì´í„° ìš”ì²­: ${getClipsResponse?.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);

                    // 4. ë™ê¸°í™” í™•ì¸
                    if (getClipsResponse?.success && getClipsResponse.data) {
                        const clips = getClipsResponse.data;
                        const savedClip = clips.find(c => c.id === dragPopupClip.id);

                        if (savedClip) {
                            addTestResult('âœ… ë“œë˜ê·¸ íŒì—… â†” í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—… ë™ê¸°í™” ì„±ê³µ', 'success');
                        } else {
                            addTestResult('âŒ ë™ê¸°í™” ì‹¤íŒ¨: ë“œë˜ê·¸ íŒì—…ì—ì„œ ì €ì¥í•œ í´ë¦½ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
                            addTestResult(`ğŸ’¡ í˜„ì¬ í´ë¦½ ìˆ˜: ${clips.length}`, 'info');
                        }
                    } else {
                        addTestResult('âŒ í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—… ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', 'error');
                    }

                    // 5. ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ í…ŒìŠ¤íŠ¸
                    addTestResult('ğŸ“¡ ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ í…ŒìŠ¤íŠ¸...');

                    const broadcastResponse = await chrome.runtime.sendMessage({
                        action: 'testStorageBroadcast'
                    });

                    if (broadcastResponse?.success) {
                        addTestResult('âœ… ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì„±ê³µ', 'success');
                    } else {
                        addTestResult('âŒ ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
                        addTestResult('ğŸ’¡ ì´ê²ƒì´ ë™ê¸°í™” ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'info');
                    }

                } else {
                    addTestResult('âš ï¸ í™•ì¥ í”„ë¡œê·¸ë¨ í™˜ê²½ì´ ì•„ë‹˜ - í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜', 'error');

                    // ì‹œë®¬ë ˆì´ì…˜: ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
                    setTimeout(() => {
                        addTestResult('âŒ (ì‹œë®¬ë ˆì´ì…˜) ë“œë˜ê·¸ íŒì—… ì €ì¥ ì„±ê³µ', 'info');
                        addTestResult('âŒ (ì‹œë®¬ë ˆì´ì…˜) í™•ì¥ í”„ë¡œê·¸ë¨ íŒì—…ì— ë°ì´í„° ì—†ìŒ', 'error');
                        addTestResult('ğŸ’¡ (ì‹œë®¬ë ˆì´ì…˜) ìŠ¤í† ë¦¬ì§€ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‹¤íŒ¨', 'info');
                        addTestResult('ğŸ¯ (ì‹œë®¬ë ˆì´ì…˜) ì´ê²ƒì´ ìš°ë¦¬ê°€ í•´ê²°í•´ì•¼ í•  ë¬¸ì œì…ë‹ˆë‹¤', 'info');
                    }, 1000);
                }

            } catch (error) {
                addTestResult(`âŒ ë“œë˜ê·¸ íŒì—… ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
                addTestResult('ğŸ’¡ ì˜¤ë¥˜ ìì²´ê°€ ë™ê¸°í™” ë¬¸ì œë¥¼ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'info');
            }
        }

        // í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
        async function testCrossContextEvents() {
            addTestResult('ğŸ”„ í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    let eventReceived = false;
                    let eventData = null;

                    // ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    const listener = (message, sender, sendResponse) => {
                        if (message.type === 'STORAGE_CHANGE') {
                            eventReceived = true;
                            eventData = message.data;
                            addTestResult('âœ… ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ìˆ˜ì‹ ', 'success');
                        }
                    };

                    chrome.runtime.onMessage.addListener(listener);

                    // ì´ë²¤íŠ¸ ë°œìƒ í…ŒìŠ¤íŠ¸
                    await chrome.runtime.sendMessage({
                        action: 'triggerStorageChange',
                        data: { test: 'cross_context_event' }
                    });

                    // ì´ë²¤íŠ¸ ìˆ˜ì‹  ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    if (eventReceived) {
                        addTestResult('âœ… í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í†µì‹  ì„±ê³µ', 'success');
                    } else {
                        addTestResult('âŒ í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹¤íŒ¨', 'error');
                        addTestResult('ğŸ’¡ ì´ë²¤íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì»¤ë‹ˆì¦˜ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤', 'info');
                    }

                    // ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
                    chrome.runtime.onMessage.removeListener(listener);

                } else {
                    addTestResult('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸ ë¶ˆê°€', 'error');
                }

            } catch (error) {
                addTestResult(`âŒ í¬ë¡œìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        async function testEventSystem() {
            addTestResult('ğŸ”„ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof StorageManager !== 'undefined') {
                    const storageManager = new StorageManager();

                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                    let eventReceived = false;

                    storageManager.addEventListener('clipCreated', (data) => {
                        eventReceived = true;
                        addTestResult(`âœ… í´ë¦½ ìƒì„± ì´ë²¤íŠ¸ ìˆ˜ì‹ : ${data.clip.title}`, 'success');
                    });

                    storageManager.addEventListener('storageChanged', (data) => {
                        addTestResult(`âœ… ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ì´ë²¤íŠ¸ ìˆ˜ì‹ : ${data.key}`, 'success');
                    });

                    addTestResult('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì„±ê³µ', 'success');

                    // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í´ë¦½ ìƒì„±
                    await storageManager.createClip({
                        title: 'ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸ í´ë¦½',
                        text: 'ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í´ë¦½ì…ë‹ˆë‹¤.',
                        source: 'test'
                    });

                    // ì´ë²¤íŠ¸ ìˆ˜ì‹  ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 500));

                    if (eventReceived) {
                        addTestResult('âœ… ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ë™ì‘ ì •ìƒ', 'success');
                    } else {
                        addTestResult('âš ï¸ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œê°„ ì´ˆê³¼', 'error');
                    }

                } else {
                    addTestResult('âš ï¸ StorageManagerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.', 'error');

                    // ì‹œë®¬ë ˆì´ì…˜
                    setTimeout(() => {
                        addTestResult('âœ… (ì‹œë®¬ë ˆì´ì…˜) ì´ë²¤íŠ¸ ìˆ˜ì‹ : clipCreated', 'success');
                        addTestResult('âœ… (ì‹œë®¬ë ˆì´ì…˜) ì´ë²¤íŠ¸ ìˆ˜ì‹ : storageChanged', 'success');
                    }, 300);
                }

            } catch (error) {
                addTestResult(`âŒ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í…ŒìŠ¤íŠ¸
        async function testDataRefresh() {
            addTestResult('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({ action: 'refreshData' });

                    if (response && response.success) {
                        const { clips, categories } = response.data;
                        addTestResult(`âœ… ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì„±ê³µ: ${clips.length} í´ë¦½, ${categories.length} ì¹´í…Œê³ ë¦¬`, 'success');
                    } else {
                        addTestResult('âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨', 'error');
                    }
                } else {
                    addTestResult('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.', 'error');

                    // ì‹œë®¬ë ˆì´ì…˜
                    setTimeout(() => {
                        addTestResult('âœ… (ì‹œë®¬ë ˆì´ì…˜) ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ', 'success');
                        updateSyncStatus();
                    }, 500);
                }

            } catch (error) {
                addTestResult(`âŒ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„±
        async function createTestClip() {
            addTestResult('ğŸ”„ í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„±...');

            try {
                const testClip = {
                    id: 'manual_test_' + Date.now(),
                    title: 'ìˆ˜ë™ í…ŒìŠ¤íŠ¸ í´ë¦½',
                    text: 'ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•œ í…ŒìŠ¤íŠ¸ í´ë¦½ì…ë‹ˆë‹¤.',
                    source: 'manual_test',
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                const clips = JSON.parse(localStorage.getItem('clips') || '[]');
                clips.push(testClip);
                localStorage.setItem('clips', JSON.stringify(clips));

                addTestResult(`âœ… í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„± ì„±ê³µ: ${testClip.title}`, 'success');

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(updateSyncStatus, 300);

            } catch (error) {
                addTestResult(`âŒ í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // CategoryManager í…ŒìŠ¤íŠ¸
        async function testCategoryManager() {
            addTestResult('ğŸ”„ CategoryManager getAllCategories() í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    // 1. CategoryManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œë„
                    addTestResult('ğŸ” CategoryManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í…ŒìŠ¤íŠ¸...');

                    const response = await chrome.runtime.sendMessage({
                        action: 'testCategoryManager'
                    });

                    if (response && response.success) {
                        addTestResult('âœ… CategoryManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ', 'success');

                        // 2. getAllCategories() ë©”ì„œë“œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
                        addTestResult('ğŸ” getAllCategories() ë©”ì„œë“œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸...');

                        const getAllResponse = await chrome.runtime.sendMessage({
                            action: 'testGetAllCategories'
                        });

                        if (getAllResponse && getAllResponse.success) {
                            addTestResult(`âœ… getAllCategories() ì„±ê³µ: ${getAllResponse.data.length}ê°œ ì¹´í…Œê³ ë¦¬`, 'success');
                        } else {
                            addTestResult(`âŒ getAllCategories() ì‹¤íŒ¨: ${getAllResponse?.error || 'ë©”ì„œë“œ ì—†ìŒ'}`, 'error');
                            addTestResult('ğŸ’¡ ì´ê²ƒì´ "getAllCategories is not a function" ì˜¤ë¥˜ì˜ ê·¼ë³¸ ì›ì¸ì…ë‹ˆë‹¤', 'info');
                        }
                    } else {
                        addTestResult(`âŒ CategoryManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${response?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    }

                    // 3. íŒì—…ì—ì„œ ì¹´í…Œê³ ë¦¬ ë¡œë”© í…ŒìŠ¤íŠ¸
                    addTestResult('ğŸ” íŒì—… ì¹´í…Œê³ ë¦¬ ë¡œë”© í…ŒìŠ¤íŠ¸...');

                    const popupResponse = await chrome.runtime.sendMessage({
                        action: 'testPopupCategoryLoading'
                    });

                    if (popupResponse && popupResponse.success) {
                        addTestResult(`âœ… íŒì—… ì¹´í…Œê³ ë¦¬ ë¡œë”© ì„±ê³µ: ${popupResponse.data.length}ê°œ ì¹´í…Œê³ ë¦¬`, 'success');
                    } else {
                        addTestResult(`âŒ íŒì—… ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨: ${popupResponse?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    }

                } else {
                    addTestResult('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ CategoryManager ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸', 'error');

                    // ì‹œë®¬ë ˆì´ì…˜: ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
                    setTimeout(() => {
                        addTestResult('âŒ (ì‹œë®¬ë ˆì´ì…˜) CategoryManager.getAllCategories is not a function', 'error');
                        addTestResult('ğŸ’¡ (ì‹œë®¬ë ˆì´ì…˜) popup.js:207ì—ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ ëˆ„ë½', 'info');
                        addTestResult('ğŸ¯ (ì‹œë®¬ë ˆì´ì…˜) CategoryManager.jsì— getAllCategories() ë©”ì„œë“œ ì¶”ê°€ í•„ìš”', 'info');
                    }, 1000);
                }

            } catch (error) {
                addTestResult(`âŒ CategoryManager í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ClipManager í…ŒìŠ¤íŠ¸
        async function testClipManager() {
            addTestResult('ğŸ”„ ClipManager getAllClips() í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    // 1. ClipManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œë„
                    addTestResult('ğŸ” ClipManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í…ŒìŠ¤íŠ¸...');

                    const response = await chrome.runtime.sendMessage({
                        action: 'testClipManager'
                    });

                    if (response && response.success) {
                        addTestResult('âœ… ClipManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ', 'success');

                        // 2. getAllClips() ë©”ì„œë“œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸
                        addTestResult('ğŸ” getAllClips() ë©”ì„œë“œ í˜¸ì¶œ í…ŒìŠ¤íŠ¸...');

                        const getAllResponse = await chrome.runtime.sendMessage({
                            action: 'testGetAllClips'
                        });

                        if (getAllResponse && getAllResponse.success) {
                            addTestResult(`âœ… getAllClips() ì„±ê³µ: ${getAllResponse.data.length}ê°œ í´ë¦½`, 'success');
                        } else {
                            addTestResult(`âŒ getAllClips() ì‹¤íŒ¨: ${getAllResponse?.error || 'ë©”ì„œë“œ ì—†ìŒ'}`, 'error');
                            addTestResult('ğŸ’¡ ì´ê²ƒì´ "getAllClips is not a function" ì˜¤ë¥˜ì˜ ê·¼ë³¸ ì›ì¸ì…ë‹ˆë‹¤', 'info');
                        }

                        // 3. ê¸°ì¡´ getClips() ë©”ì„œë“œì™€ ë¹„êµ
                        addTestResult('ğŸ” getClips() ë©”ì„œë“œ ë¹„êµ í…ŒìŠ¤íŠ¸...');

                        const getResponse = await chrome.runtime.sendMessage({
                            action: 'testGetClips'
                        });

                        if (getResponse && getResponse.success) {
                            addTestResult(`âœ… getClips() ì„±ê³µ: ${getResponse.data.length}ê°œ í´ë¦½`, 'success');
                            addTestResult('ğŸ’¡ getClips()ëŠ” ì¡´ì¬í•˜ì§€ë§Œ getAllClips()ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
                        } else {
                            addTestResult(`âŒ getClips() ì‹¤íŒ¨: ${getResponse?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                        }

                    } else {
                        addTestResult(`âŒ ClipManager ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹¤íŒ¨: ${response?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    }

                } else {
                    addTestResult('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ClipManager ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸', 'error');

                    // ì‹œë®¬ë ˆì´ì…˜: ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ í‘œì‹œ
                    setTimeout(() => {
                        addTestResult('âŒ (ì‹œë®¬ë ˆì´ì…˜) ClipManager.getAllClips is not a function', 'error');
                        addTestResult('ğŸ’¡ (ì‹œë®¬ë ˆì´ì…˜) popup.js:191, 338ì—ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ ëˆ„ë½', 'info');
                        addTestResult('ğŸ¯ (ì‹œë®¬ë ˆì´ì…˜) ClipManager.jsì— getAllClips() ë©”ì„œë“œ ì¶”ê°€ í•„ìš”', 'info');
                        addTestResult('ğŸ”„ (ì‹œë®¬ë ˆì´ì…˜) CategoryManager.getAllCategories() íŒ¨í„´ê³¼ ì¼ê´€ì„± í•„ìš”', 'info');
                    }, 1000);
                }

            } catch (error) {
                addTestResult(`âŒ ClipManager í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // íŒì—… ë¡œë”© í…ŒìŠ¤íŠ¸
        async function testPopupLoading() {
            addTestResult('ğŸ”„ íŒì—… ë¡œë”© í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    // íŒì—… ë¡œë”© ì‹œë®¬ë ˆì´ì…˜
                    addTestResult('ğŸ” íŒì—… ì´ˆê¸°í™” ë¡œë”© í…ŒìŠ¤íŠ¸...');

                    const popupResponse = await chrome.runtime.sendMessage({
                        action: 'testPopupInitialization'
                    });

                    if (popupResponse && popupResponse.success) {
                        addTestResult('âœ… íŒì—… ì´ˆê¸°í™” ì„±ê³µ', 'success');

                        // ì¹´í…Œê³ ë¦¬ ë¡œë”© í…ŒìŠ¤íŠ¸
                        if (popupResponse.data.categories) {
                            addTestResult(`âœ… ì¹´í…Œê³ ë¦¬ ë¡œë”© ì„±ê³µ: ${popupResponse.data.categories.length}ê°œ`, 'success');
                        } else {
                            addTestResult('âŒ ì¹´í…Œê³ ë¦¬ ë¡œë”© ì‹¤íŒ¨', 'error');
                        }

                        // í´ë¦½ ë¡œë”© í…ŒìŠ¤íŠ¸
                        if (popupResponse.data.clips) {
                            addTestResult(`âœ… í´ë¦½ ë¡œë”© ì„±ê³µ: ${popupResponse.data.clips.length}ê°œ`, 'success');
                        } else {
                            addTestResult('âŒ í´ë¦½ ë¡œë”© ì‹¤íŒ¨: getAllClips() is not a function', 'error');
                        }
                    } else {
                        addTestResult(`âŒ íŒì—… ì´ˆê¸°í™” ì‹¤íŒ¨: ${popupResponse?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
                    }

                } else {
                    addTestResult('âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ íŒì—… ë¡œë”© ì‹œë®¬ë ˆì´ì…˜', 'error');

                    setTimeout(() => {
                        addTestResult('âŒ (ì‹œë®¬ë ˆì´ì…˜) íŒì—… ë¡œë”© ì‹¤íŒ¨: Error loading data', 'error');
                        addTestResult('ğŸ’¡ (ì‹œë®¬ë ˆì´ì…˜) this.clipManager.getAllClips is not a function', 'error');
                        addTestResult('ğŸ¯ (ì‹œë®¬ë ˆì´ì…˜) ë¶ë§ˆí¬íˆ´ë°”ì—ì„œ íŒì—… ì—´ ë•Œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜', 'info');
                    }, 1000);
                }

            } catch (error) {
                addTestResult(`âŒ íŒì—… ë¡œë”© í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // Chrome Storage ì§ì ‘ í™•ì¸ í…ŒìŠ¤íŠ¸
        async function testChromeStorage() {
            addTestResult('ğŸ”„ Chrome Storage ì§ì ‘ í™•ì¸ í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            try {
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    // 1. clips ë°ì´í„° ì§ì ‘ í™•ì¸
                    addTestResult('ğŸ” Chrome storageì—ì„œ clips ë°ì´í„° í™•ì¸...');

                    const result = await chrome.storage.local.get(['clips']);
                    const clips = result.clips || [];

                    addTestResult(`ğŸ“Š Storageì— ì €ì¥ëœ í´ë¦½ ìˆ˜: ${clips.length}`, 'info');

                    if (clips.length > 0) {
                        addTestResult(`âœ… í´ë¦½ ë°ì´í„° ìˆìŒ: ${clips.length}ê°œ`, 'success');

                        // ì²« ë²ˆì§¸ í´ë¦½ ì •ë³´ í‘œì‹œ
                        const firstClip = clips[0];
                        addTestResult(`ğŸ“‹ ì²« í´ë¦½: "${firstClip.title || firstClip.text?.substring(0, 50)}..."`, 'info');
                        addTestResult(`ğŸ•’ ìƒì„± ì‹œê°„: ${new Date(firstClip.createdAt).toLocaleString()}`, 'info');
                    } else {
                        addTestResult('âš ï¸ Storageì— í´ë¦½ ë°ì´í„° ì—†ìŒ', 'error');
                    }

                    // 2. categories ë°ì´í„° í™•ì¸
                    const categoryResult = await chrome.storage.local.get(['categories']);
                    const categories = categoryResult.categories || [];

                    addTestResult(`ğŸ“ Storageì— ì €ì¥ëœ ì¹´í…Œê³ ë¦¬ ìˆ˜: ${categories.length}`, 'info');

                    if (categories.length > 0) {
                        addTestResult(`âœ… ì¹´í…Œê³ ë¦¬ ë°ì´í„° ìˆìŒ: ${categories.length}ê°œ`, 'success');
                        categories.forEach(cat => {
                            addTestResult(`ğŸ“‚ ${cat.name} (ID: ${cat.id})`, 'info');
                        });
                    } else {
                        addTestResult('âš ï¸ Storageì— ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì—†ìŒ', 'error');
                    }

                    // 3. í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„±
                    addTestResult('ğŸ”„ í…ŒìŠ¤íŠ¸ í´ë¦½ ìƒì„± ì‹œì‘...');

                    const testClip = {
                        id: 'storage_test_' + Date.now(),
                        title: 'Storage Test Clip',
                        text: 'ì´ í´ë¦½ì€ Chrome Storage í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
                        source: 'storage_test',
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        categoryIds: []
                    };

                    // Storageì— ì§ì ‘ ì €ì¥
                    const allClips = [...clips, testClip];
                    await chrome.storage.local.set({ clips: allClips });

                    addTestResult(`âœ… í…ŒìŠ¤íŠ¸ í´ë¦½ ì €ì¥ ì„±ê³µ (ID: ${testClip.id})`, 'success');

                    // 4. ì €ì¥ í™•ì¸
                    const verifyResult = await chrome.storage.local.get(['clips']);
                    const verifyClips = verifyResult.clips || [];
                    const savedClip = verifyClips.find(c => c.id === testClip.id);

                    if (savedClip) {
                        addTestResult('âœ… í…ŒìŠ¤íŠ¸ í´ë¦½ ì €ì¥ í™•ì¸ ì„±ê³µ', 'success');
                    } else {
                        addTestResult('âŒ í…ŒìŠ¤íŠ¸ í´ë¦½ ì €ì¥ í™•ì¸ ì‹¤íŒ¨', 'error');
                    }

                } else {
                    addTestResult('âŒ Chrome storage API ì‚¬ìš© ë¶ˆê°€', 'error');
                }

            } catch (error) {
                addTestResult(`âŒ Chrome Storage í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬
        async function clearTestData() {
            addTestResult('ğŸ”„ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬...');

            try {
                const clips = JSON.parse(localStorage.getItem('clips') || '[]');
                const testClips = clips.filter(clip =>
                    clip.id.includes('test') ||
                    clip.id.includes('manual_test') ||
                    clip.source === 'test' ||
                    clip.source === 'manual_test'
                );

                const cleanedClips = clips.filter(clip =>
                    !clip.id.includes('test') &&
                    !clip.id.includes('manual_test') &&
                    clip.source !== 'test' &&
                    clip.source !== 'manual_test'
                );

                localStorage.setItem('clips', JSON.stringify(cleanedClips));

                addTestResult(`âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ: ${testClips.length}ê°œ í•­ëª© ì‚­ì œ`, 'success');

                // ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(updateSyncStatus, 300);

            } catch (error) {
                addTestResult(`âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            addTestResult('ğŸ”„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
            updateSyncStatus();

            // 5ì´ˆë§ˆë‹¤ ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸
            setInterval(updateSyncStatus, 5000);
        });

        // ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ê°ì§€ (ì‹¤ì œ ë™ê¸°í™” í…ŒìŠ¤íŠ¸)
        if (typeof window !== 'undefined') {
            window.addEventListener('storage', (e) => {
                addTestResult(`ğŸ”„ ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ê°ì§€: ${e.key}`, 'info');
                updateSyncStatus();
            });
        }
    </script>
</body>
</html>